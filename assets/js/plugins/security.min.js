if ("geolocation" in navigator) {
  localizar();
} else {
  $("#text-pantalla-loc").html(
    "El navegador no es compatible, por favor intente con otro."
  );
  // no se permite usar por el navegador
}

function localizar() {
  navigator.geolocation.getCurrentPosition(show_location, show_error); //position request
}

var lat_r;
var lon_r;

function show_location(position) {
  lat_r = position.coords.latitude;
  lon_r = position.coords.longitude;
  $("#arrowsLocation").hide();
  $(".error_loc").hide();
}

function show_error(error) {
  switch (error.code) {
    case error.PERMISSION_DENIED:
      $("#arrowsLocation").show();
      break;
    default:
      $(".error_loc").show();
      break;
  }
}

document.addEventListener("contextmenu", (event) => event.preventDefault());

var pass = "";

function fuerza(value) {
  var strongRegex = new RegExp(
    "^(?=.{8,})(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])(?=.*\\W).*$",
    "g"
  );
  var mediumRegex = new RegExp(
    "^(?=.{7,})(((?=.*[A-Z])(?=.*[a-z]))|((?=.*[A-Z])(?=.*[0-9]))|((?=.*[a-z])(?=.*[0-9]))).*$",
    "g"
  );
  var enoughRegex = new RegExp("(?=.{6,}).*", "g");

  if (false == enoughRegex.test(value)) {
    $("#passstrength").html("");
    $("#passstrength").width("0%");
    pass = "0";
  } else if (strongRegex.test(value)) {
    $("#passstrength").width("100%");
    $("#passstrength").html("Fuerte");
    pass = "100";
  } else if (mediumRegex.test(value)) {
    $("#passstrength").width("50%");
    $("#passstrength").html("Media");
    pass = "50";
  } else {
    $("#passstrength").width("25%");
    $("#passstrength").html("Debil");
    pass = "25";
  }
}

function vistas(vista) {
  if (vista == "inicial") {
    $(".left").css("width", "220px");
    $("form").css("width", "300px");

    $("input").val("");

    $("#vista").html(`
    <form action="" autocomplete="off">
    <h4>Bienvenido a <span>GITCOM</span></h4>
    <p>ingrese sus credenciales para acceder al sistema.</p>
    <div class="floating-label">
      <input placeholder="Correo" type="text" name="email" id="user" autocomplete="off">
      <label for="user">Correo</label>
      <div class="icon">
      <span class="st1 icon-envelope"></span>
      </div>
    </div>
    <div class="floating-label">
      <input placeholder="Contraseña" type="password" name="password" id="pass" autocomplete="off">
      <label for="pass">Contraseña</label>
      <div class="icon">
        <span class="st1 icon-lock"></span>
      </div>
    </div>
    <button type="button" onclick="validate()" id="botonVerificar">Iniciar</button>
    <a class="discrete" style="margin-top: 27px;" onclick="vistas('recuperar')">¿Olvidó su contraseña?</a>
    <a class="discrete" style="margin-top: 10px; color: #ff3d10;" onclick="vistas('acceso')">Solicitar acceso</a>

  </form>`);
  } else if (vista == "recuperar") {
    $("#vista").html(`<section id="section-recuperar">
      <form action="" autocomplete="off">
      <h4>Recuperación</h4>
      <p>Ingrese el correo electrónico asociado a su <strong>cuenta gitcom</strong>.</p>
      <div class="floating-label">
        <input placeholder="Correo" type="text" id="rec_correo" autocomplete="off">
        <label for="user">Correo</label>
        <div class="icon">
        <span class="st1 icon-envelope"></span>
        </div>
      </div>

      <button type="button" onclick="recuperar('vc')" id="botonSiguiente">Siguiente</button>


      <a class="discrete" style="margin-top: 50px;" onclick="vistas('inicial')">Cancelar</a>

    </form>
  
      </section>`);
  } else if (vista == "acceso") {
    $(".left").css("width", "52px");

    $("#vista").html(`
    <form action="" autocomplete="off">
          <h4>Bienvenido a <span>GITCOM</span></h4>
          <p>Registre sus datos y valide su correo electrónico. El equipo de soporte de usuarios se comunicara con usted para validar su identidad.</p>

          <div class="row">

            <div class="col-lg-6">

              <div class="floating-label">
                <input placeholder="Correo electrónico" class="w100" type="text" id="c_correo" autocomplete="off">
                <label for="c_correo" class="p0">Correo electrónico</label>
              </div>
              <div class="floating-label">
                <input placeholder="Cedula" class="w100" type="text" id="c_cedula" autocomplete="off">
                <label for="user" class="p0">Cedula</label>
              </div>
              <div class="floating-label">
                <input placeholder="Nombre" class="w100" type="text" id="c_nombre" autocomplete="off">
                <label for="user" class="p0">Nombre</label>
              </div>
            </div>
            <div class="col-lg-6">
            <div class="floating-label">
              <input placeholder="Telefono" class="w100" type="text" id="c_telefono" onkeyup="validarTelefonoC(this.value)" autocomplete="off">
              <label for="c_telefono" class="p0">Telefono</label>

            <span id="error_telefono_2" title="El formato del telefono no es correcto (4120000000)" class="icon-exclamation"></span>

            </div>
              <div class="floating-label">
                <select id="c_tipo" class="w100" onchange="tipoUserDiv(this.value)">
                  <option value="">Seleccione</option>
                  <option value="3">Institución</option>
                  <option value="4">Comunitario</option>
                </select>
                <label for="c_tipo" class="p0">Tipo de usuario</label>
              </div>
              <section id="tipoUserDiv"></section>
            </div>

          </div>

          <button type="button" onclick="solicitar()" id="botonSolicitar">Solicitar acceso</button>
          <a class="discrete" style="margin-top: 20px;" onclick="vistas('inicial')">¿Ya tiene una cuenta? Inicie sesión</a>
        </form>
    `);

    setTimeout(w600, 100);
  }
}

function w600() {
  $("form").css("width", "600px");
}
vistas("inicial");

var rec_correo = "";
var rec_tel = "";
var rec_cod = "";

function validarEmail(valor) {
  if (
    /^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i.test(
      valor
    )
  ) {
    return true;
  } else {
    return false;
  }
}

function solicitar() {
  let c_correo = $("#c_correo").val();
  let c_cedula = $("#c_cedula").val();
  let c_nombre = $("#c_nombre").val();
  let c_telefono = $("#c_telefono").val();
  let c_tipo = $("#c_tipo").val();
  let c_lugar = $("#c_lugar").val();

  if (!validarEmail(c_correo)) {
    toast("error", "Ingrese un correo con un formato valido.");
    return;
  }
  if (
    c_correo == "" ||
    c_cedula == "" ||
    c_nombre == "" ||
    c_telefono == "" ||
    c_tipo == "" ||
    c_lugar == ""
  ) {
    toast("error", "Rellene todos los campos");
    return;
  }

  if (lat_r == "" || lon_r == "") {
    localizar();
    return;
  }

  $.ajax({
    url: "login/solicitud.php",
    type: "POST",
    dataType: "html",
    data: {
      c_correo: c_correo,
      c_cedula: c_cedula,
      c_nombre: c_nombre,
      c_telefono: c_telefono,
      c_tipo: c_tipo,
      c_lugar: c_lugar,
      lat_r: lat_r,
      lon_r: lon_r,
    },
  }).done(function (response) {
    if (response.trim() == "EX") {
      toast("error", "Acción no permitida");
    } else if (response.trim() == "1") {
      vistas("inicial");

      Swal.fire({
        title: "Solicitud enviada",
        html: "Solicitud enviada correctamente, el equipo de soporte de usuarios se comunicara con usted para validar su identidad.",
        icon: "success",
        showCancelButton: false,
        confirmButtonColor: "#ed5264",
        confirmButtonText: "Ok",
      }).then((result) => {});
    }
  });
}

function recuperar(tipo) {
  if (tipo == "vc") {
    rec_correo = $("#rec_correo").val();
    if ($("#rec_correo").val() == "") {
      toast("error", "Rellene todos los campos");
      return;
    }
  }
  if (tipo == "tl") {
    rec_tel = $("#rec_tel").val();
    if ($("#rec_tel").val() == "") {
      toast("error", "Rellene todos los campos");
      return;
    }
  }
  if (tipo == "cod") {
    rec_cod = $("#rec_cod").val();

    if ($("#rec_cod").val() == "") {
      toast("error", "Rellene todos los campos");
      return;
    }
  }

  let rec_pss = "";

  if (tipo == "pass") {
    if (pass != "100") {
      toast(
        "error",
        "La contraseña debe tener al menos una (1) mayúscula, un (1) numero y un (1) carácter especial."
      );
      return;
    }

    if ($("#rec_pss").val() == "" || $("#rec_pss_1").val() == "") {
      toast("error", "Rellene todos los campos");
      return;
    }
    if ($("#rec_pss").val() != $("#rec_pss_1").val()) {
      toast("error", "Las contraseñas no coinciden");
      return;
    }
    rec_pss = $("#rec_pss").val();
  }

  if (pass != "100") {
    toast(
      "error",
      "La contraseña debe tener al menos una (1) mayúscula, un (1) numero y un (1) carácter especial."
    );
    return;
  }

  $(".container-line-loader").show();
  $("#botonSiguiente").prop("disabled", true);
  $.ajax({
    url: "login/recuperar.php",
    type: "POST",
    dataType: "html",
    data: {
      rec_correo: rec_correo,
      rec_tel: rec_tel,
      rec_cod: rec_cod,
      rec_pss: rec_pss,
      tipo: tipo,
    },
  }).done(function (response) {
    $(".container-line-loader").hide();
    $("#botonSiguiente").prop("disabled", false);
    if (tipo == "vc") {
      if (response.trim() != "NE") {
        $("#section-recuperar").html(
          `<form action="" autocomplete="off">
          <h4>Recuperación</h4>
          <p>Para proteger su cuenta, es necesario validar su identidad.
          <br>
          <br>
          Confirma el número de teléfono que proporcionaste en la configuración de seguridad: 4••-•••••` +
            response.trim() +
            `
          </p>
          <div class="floating-label">
            <input placeholder="Telefono" type="text" onkeyup="formatoTelefono(this.value)" id="rec_tel" autocomplete="off">
            <label for="user">Telefono</label>
            <div class="icon">
            <span class="st1 icon-screen-smartphone"></span>

            </div>
            <span id="error_telefono" title="El formato del telefono no es correcto (4120000000)" class="icon-exclamation"></span>
          </div>
    
          <button type="button" onclick="recuperar('tl')" id="botonSiguiente">Siguiente</button>
          <a class="discrete" style="margin-top: 50px;" onclick="vistas('inicial')">Cancelar</a>
    
        </form>`
        );
      } else {
        toast("error", "No se reconoce el correo suministrado");
      }
    } else if (tipo == "tl") {
      if (response.trim() != "NE") {
        $("#section-recuperar").html(`<form action="" autocomplete="off">
          <h4>Recuperación</h4>
          <p>Se envío un código de recuperación a su correo.</p>
          <div class="floating-label">
            <input placeholder="Código" type="text" id="rec_cod" autocomplete="off">
            <label for="user">Código</label>
            <div class="icon">
            <span class="st1 icon-lock"></span>
            </div>
          </div>
    
          <button type="button" onclick="recuperar('cod')" id="botonSiguiente">Siguiente</button>
          <a class="discrete" style="margin-top: 50px;" onclick="vistas('inicial')">Cancelar</a>
    
        </form>`);
      } else {
        toast("error", "No se pudo validar la información");
      }
    } else if (tipo == "cod") {
      if (response.trim() != "NC") {
        $("#section-recuperar").html(`<form action="" autocomplete="off">
        <h4>Recuperación</h4>
        <p>Indique su nueva contraseña</p>

        <div class="floating-label">
          <input placeholder="Contraseña" type="password" onkeyup="fuerza(this.value)" id="rec_pss" autocomplete="off" >
          <label for="user">Contraseña</label>
          <div class="icon">
          <span class="st1 icon-lock"></span>
          </div>
          <span title="Contraseña no permitida" id="error_pss" class="icon-exclamation"></span>

        </div>

        
    <div class="progress mt-2"  style="    width: 89%;margin-left: 40px;">
    <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"  id="passstrength">
    </div>
  </div>




        <div class="floating-label">
          <input placeholder="Repita la contraseña" type="password" id="rec_pss_1" autocomplete="off">
          <label for="user">Repita la contraseña</label>
          <div class="icon">
          <span class="st1 icon-lock"></span>
          </div>
          <span title="Las contraseña no coinciden" id="error_pss2" class="icon-exclamation"></span>

        </div>

        <button type="button" onclick="recuperar('pass')" id="botonSiguiente">Siguiente</button>
        <a class="discrete" style="margin-top: 50px;" onclick="vistas('inicial')">Cancelar</a>

      </form>`);
      } else {
        toast("error", "El código es incorrecto");
      }
    } else if (tipo == "pass") {
      if (response.trim() == "OK") {
        toast("success", "Actualizado correctamente");
        vistas("inicial");
      }
    }
  });
}

function formatoTelefono(telefono) {
  if (telefono.length != 10) {
    $("#error_telefono").show(300);
    $("#botonSiguiente").prop("disabled", true);
  } else {
    $("#error_telefono").hide(300);
    $("#botonSiguiente").prop("disabled", false);
  }
}
function validarTelefonoC(telefono) {
  if (telefono.length != 10) {
    $("#error_telefono_2").show(300);
    $("#botonSolicitar").prop("disabled", true);
  } else {
    $("#error_telefono_2").hide(300);
    $("#botonSolicitar").prop("disabled", false);
  }
}
function formatoPass(pss) {
  if (pss.length < 10 || pss.indexOf("123") != -1) {
    $("#error_pss").show(300);
    $("#botonSiguiente").prop("disabled", true);
  } else {
    $("#error_pss").hide(300);
    $("#botonSiguiente").prop("disabled", false);
  }
}

function tipoUserDiv(tipo) {
  if (tipo == "3") {
    $("#tipoUserDiv").html(`
 
    <div class="floating-label">
      <input placeholder="Nombre de la institución" class="w100" type="text" id="c_lugar" autocomplete="off">
      <label for="user" class="p0">Nombre de la institución</label>
      </div>
    `);
  } else if (tipo == "4") {
    $("#tipoUserDiv").html(`
    
    <div class="floating-label">
      <input placeholder="Comunidad" class="w100" type="text" id="c_lugar" autocomplete="off">
      <label for="user" class="p0">Comunidad</label>
      </div>

    `);
  } else {
    $("#tipoUserDiv").html(``);
  }
}

/* user validation */
/* user validation */
/* user validation */
/* user validation */
/* user validation */
/* user validation */
/* user validation */
/* user validation */
/* user validation */

function validate() {
  if ($("#user").val() == "" || $("#password").val() == "") {
    toast("warning", "Rellene todos los campos");
  } else {
    $("#botonVerificar").attr("disabled", true);
    $(".container-line-loader").show();

    $.ajax({
      url: "login/validate.php",
      type: "POST",
      dataType: "html",
      data: {
        user: $("#user").val(),
        password: $("#pass").val(),
      },
    }).done(function (resultado) {
      $(".container-line-loader").hide();

      $("#botonVerificar").attr("disabled", false);
      if (resultado.trim() == "false") {
        $("#pass").val("");
        toast("info", "Usuario y/o contraseña incorrecta");
      } else if (resultado.trim() == "false-2") {
        $("#pass").val("");
        toast("info", "Usuario bloqueado temporalmente");
      } else if (resultado.trim() == "true") {
        $(".container-line-loader").show();

        $("#vista").html(`
            <form action="" autocomplete="off">
            <h4>Bienvenido a <span>GITCOM</span></h4>
           
            <p>Ingrese a su correo y haga click en el enlace de validación. <strong>No cierre esta pestaña!</strong> </p>
            
            <img src="assets/img/email.gif" alt="email" class="email-gif">

          </form>`);

        setInterval(() => {
          validate2();
        }, 5000);
      }
    });
  }
}

function validate2() {
  $.ajax({
    url: "login/validateCopia.php",
    type: "POST",
    dataType: "html",
  }).done(function (resultado) {
    console.log(resultado);
    const response = JSON.parse(resultado);

    if (response.status == true) {
      window.location.href = "pages/" + response.page;
    } else {
      console.log(response.msg);
    }
  });
}
